# AWS Batch

## What is batch computing?

シミュレーションなどの負荷の高い計算をスパコンやクラスタで順次実行していくような処理

- 定型業務におけるバッチ処理
  - ジョブの起動や順序を定義
- 大規模計算におけるバッチ処理 (AWS Batchはこちら向け)
 - CGレンダリング、大規模化学計算、機械学習、ゲノム分析

## AWS Batchとは
- Dockerコンテナイメージをもとに作成する
  - イメージが必要

## 価格
- 利用自体は無料だが、起動されるEC2インスタンスに課金

## メリット
- 複数のジョブを同時実行させることができる
  - タスクに適したマシン構成
    - 同時利用コア数をスケールできる
- 最新CPU使える

- フルマネージドで提供
 - ジョブキュー
 - コンピューティング環境のスケール&スケールアウト
 - タイムアウト、リトライ

- 他サービスとの連携
  - CloudWatch Events
  - StepFunctions
  - CloudTrail

## 他のサービスのほうが適しているケース
- コンテナ化できない場合
  - ライセンス関係で

- 既存のジョブスケジューラから移行が難しい
  - AWS ParallelClusterを検討する

- 1つのジョブが数秒の程度
  - 起動されるEC2は数分かかる（当たり前）
  - Step Functinos + LambdaやS3 Batchの利用を検討

- 機械学習用途でモデル設計や推論エンドポイント構築
  - Sage Maker

### ジョブ定義
ジョブ作成する際のテンプレート

- パラメータ例
  - コンテナイメージ
  - コンテナ内での実行コマンド
  - 実行コマンドに渡されるパラメータ
  - 再試行戦略、タイムアウト
  - ジョブが使う、IAM Role
  - 要求vCPU メモリ、GPU
  - マルチノードの利用するか
  - mount point
  - ulimit

### ジョブ
- パラメータ例
  - ジョブ定義
  - コンテナイメージ
  - コンテナ内での実行コマンド
  - 投入沙希ジョブキュー
  - 実行コマンドに渡されるパラメータ
  - 再試行戦略、タイムアウト
  - ジョブが使う、IAM Role
  - 要求vCPU メモリ、GPU
  - マルチノードの利用するか
  - mount point
  - ulimit

### ジョブキュー
ジョブの待ち行列
- パラメータ例
  - 実行沙希コンピューティング環境（3つまで)
  - ジョブキューの優先度

### コンピューティング環境
計算を行うECSクラスター

- パラメータ例
  - Managed or Unmanaged
  - オンデマンド or スポット
  - 最小、最大vCPU数
    - 最小0にすれば、起動しないこともできる
  - 許可されたインスタンスタイプ
    - 直接インスタンスタイプや、インスタンスファミリー、Opimalを指定できる
  - VPC, Subnet, セキュリティグループ
  - PlacementGroup

## 機能

- ジョブ状態
  - Amazon SNSで通知可能
  - Submitted
  - Pending
  - Runnnable ... EC2の準備中。リソースが指定されたコンピューティング環境が含まれない場合はここで止まる
  - Starting
  - Running
  - Succeeded
  - FAILED

- 配列ジョブ ... 1回のジョブ投入で複数の子ジョブを作成できる
  - $AWS_BATCH_JOB_ARRAY_INDEX から自分の配列IDを取得可能
  - 配列IDによって処理を分けることが可能

- ジョブ依存関係
  - 指定できる

- ジョブパターン
  - 集約パターン ... 配列ジョブで処理をして、次のジョブでジョブ結果を集約
  - 前処理パターン ... 前処理ジョブを行い、その後配列ジョブで前処理結果をもとに処理をする
  - シーケンシャルパターン ... 配列ジョブの中で依存関係を定義する

- タイムアウト、再試行回数
  - 必ず指定してね（ずっとEC2残って課金が発生するため）

- コンピューティング環境
  - 基本的にはマネージド型を指定
  - マルチAZを指定する
  - EC2 Launch Template

- セキュリティ
  - IAM Policy
    - POSIXユーザの制限
    - 利用可能なコンテナイメージ／レジストリ

- マルチノード並列ジョブ
  - ジョブ定義のみで有効化
  - インスタンスタイプは固定
  - クラスタープレイスメントグループの利用も検討
  - 1ジョブの実行時間は短縮できるが、大量のジョブを実行する場合には価格性能比に注意

## ジョブの投入方法

- ユーザやコンソールや、CLIから
- S3トリガー-> Lambda -> API経由でジョブ投入
- CloudWatchEventでスケジューリングしてジョブ投入

## スポットインスタンス

非常に安価だが、空きがなくなると利用中に中断が発生して、インスタンスがTerminateされることがある

- インスタンスタイプを幅広く設定する
- 再試行回数を設定しておく
- 一つのジョブの処理内容を短時間で終わるようにする
- S3や、EFS二定期的に結果を出力して、再実行した際に、途中から処理を再開できるようにするチェックポイント方式

## ストレージ
- S3
  - マウントはできない
    - 小さい大量のファイルは圧縮してね
- EFS
  - 起動テンプレート内でマウント
- FSx for Lustre

## Reference

 - [【AWS Black Belt Online Seminar】AWS Batch - YouTube](https://www.youtube.com/watch?v=-2Kz3d7hPBk)
 - [20190911 AWS Black Belt Online Seminar AWS Batch](https://www.slideshare.net/AmazonWebServicesJapan/20190911-aws-black-belt-online-seminar-aws-batch)