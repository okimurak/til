# W-A

## 一般的な設計原則

- 必要なキャパシティーの推測が不要に
- 本稼働スケールでシステムをテスト
- 自動化によってアーキテクチャでの実験を用意
- 発展するアーキテクチャが可能
- データに基づいてアーキテクチャを進化
- ゲームデーを利用して改善

## 運用上の優秀性

設計原則は下記の通り
- 運用をコードとして実行
- ドキュメントに注釈を
  - オンプレではドキュメントは手動作成だけど、ビルド時に注釈をつけたドキュメントを作成さえる
- 定期的に、**小規模な、元にに戻すことができる**変更を適用する
- 運用手順を定期的に改善
- 障害を予想
- 運用上のすべての障害から学ぶ

### ベストプラクティス

- 準備
  - 優先順位の決定方法 ... 共通の目標を設定
    - 外部の顧客のニーズ
    - 内部顧客のニーズ
    - コンプライアンス
    - 脅威の状況を評価
    - トレードオフを評価
    - メリットとリスクを管理
  - ワークロードの設計 ... すべてのコンポーネントに渡って内部状態を理解するために必要な情報を送出
    - アプリケーションテレメトリーを実装
      - 内部状態、ステータスの情報が創出されるように実装する。キューの長さ、エラーメッセージ、応答時間の情報
    - ワークロードテレメトリーを実装
      - API呼び出しボリューム、httpステータスコード、スケーリングイベント
    - ユーザアクティビティテレメトリーを実装する
      - クリックストリーム、開始、放棄、完了済みトランザクション
    - 依存関係のテレメトリーを実装する
      - 外部DB,DNS、ネットワーク接続性
    - トランザクショントレーサビリティを実装する
      - 全体のトランザクションフローに関する情報を送出
  - どのように欠点を減らし、修正を簡単にし、本番へのフロー改善するか
    - リファクタリング(正しい)、品質についてのフィードバック、バグ修正を可能にし、本番環境への変更フローを改善するアプローチを採用
      - バージョン管理
      - 変更をテスト
      - 構成管理システム
      - 構成及びデプロイ管理システム
      - パッチ管理
      - 設計標準を共有
      - コード品質のためのプラクティス
        - TTD、コードレビュー、標準のどうにゅう
      - 複数の環境を使用する
      - 頻繁に、小さく、可逆的な変更
      - 統合とデプロイを自動化（CI/CD)
  - デプロイのリスクを低減
    - 品質に関する迅速なフィードバックを提供
      - 変更の失敗に備える
      - 変更をテスト
      - デプロイ管理システム
      - 限定的なデプロイを使用して、テスト
        - デプロイカナリアテスト、ワンボックスデプロイ
      - 並列環境でデプロイする
      - 頻繁に、小さく、可逆的な変更
      - 統合とデプロイを自動化
      - テストとロールバックを自動化
  - ワークロードをサポートする準備の確認
    - ワークロード、プロセス、手順、従業員の運用準備状況を評価して、運用上のリスクを理解する必要がある
      - 従業員の対応力の確保
      - 運用準備状況の一貫した確認
      - ランブック（実施手順書）
      - プレイブック（問題調査用の手順）
      - システム変更をデプロイするために十分情報に基づいて決定を下す
  - AWS Configで環境が標準に沿っているかを確認できる

- 運用
  - 成功を評価する方法を決定し、成功判定の計算に使用する運用のメトリクスを特定する
  - ワークロードメトリクスの定義、キャプチャ、分析をすると適切なアクションが取れるようにワークロードイベントの可視性を高める
    - KPI
    - メトリクスのレビュー
    - 異常時の警告通知
    - 上記2つの成果の達成度と有効性検証
  - オペレーションの正常性をどのように把握するか
    - オペレーションメトリクスを定義し、キャプチャし、分析すると(ry
  - ワークロードと運用イベントはどのように管理するか
    - 手順を準備、検証してワークロードの中断を最小限に
    - イベント、インシデント、問題に対する管理プロセスを使う
    - 根本原因の分析のプロセスを使う
    - アラート毎のプロセスを使う
    - 運用上のイベントを優先する
    - エスカレーションルート
    - プッシュ通知
    - ダッシュボード
    - イベントへの対応を自動化
  - 日常的な運用や計画外のイベントへの応答は自動化する
  - デプロイ、リリース管理、変更、ロールバックは手作業のプロセスは避ける
  - リリースは、低頻度で行われる大規模なバッチ処理にしないようにする
  - CLoudWatchで運用状態をモニタリング
- 進化
  - 漸近的な継続的改善の仕組みを作り、時間とリソースを費やすこと
    - フィードバックループ
  - Elastic search Serviceで分析する

## セキュリティ

設計原則は下記の通り

- 強力なアイデンティティ基盤の実装と最小権限の原則
- トレーサビリティ
- 全レイヤーへのセキュリティ適用
- ベストプラクティスの自動化
- 伝送中及び補完中のデータ保護
- **データに人の手を入れない**
- セキュリティイベントへの備え

### ベストプラクティス

- アイデンティティ管理とアクセス管理
  - IAM使おうね
    - ルートユーザを保護(MFA)
    - MFAを義務
    - アクセスコントロールの義務化を自動化
    - 一元化されたフェデレーションプロバイダーと統合
      - SAML
    - パスワード要件を義務化
    - 認証情報を定期的にローテーション
    - 定期的な監査
- 発見的統制
  - セキュリティの潜在的な脅威やインシデントを特定
    - ログの要件定義
    - メトリクスの要件定義
    - アラートの要件定義
    - サービスとアプリケーションのログ記録を設定
    - ログを一元的に分析
    - アラートの自動化
    - 調査プロセスを開発
  - 内部監査
  - CloudTrailログ、APIコール、CLoudWatchのメトリクスモニタリング、AWS Configの設定履歴
  - Amazon GuardDutyによる脅威検出
- インフラストラクチャ保護
  - VPCで保護
  - ネットワークの保護はどうやる
    - 内部及び外部のネットワークベースの脅威から保護するため、複数防御レイヤーが必要
      - VPCの場合、SGやネットワークACL、サブネットで保護
      - Lambdaの場合はプライベートVPCで実行することを検討する
  - コンピューティングリソースは？
    - 複数の防御レイヤーが必要(ry
      - 脆弱性をスキャンしパッチ適用
      - 設定管理を自動化
      - コンピューティング保護を自動化
      - 攻撃領域を削減
        - コンテナやサーバレスで攻撃領域を削減
      - マネージドサービスを使う
  - AWS WAF
- データ保護
  - ファイルアクセスや変更ログ
  - バージョニングによる誤削除防止
  - データの分類は、機密レベルを基準に行う
  - 伝送中及び保存データは暗号化で保護
    - KMSや ACMの利用を検討する
  - S3, ELB, EBS, RDS
  - Amazon Machieは機密性の高いデータを分類・保護
- インシデント対応
  - 本番を想定したセキュリティインシデント対応を定期的に実行
  - フォレンジック環境を作成できるようにしておく
  - インシデント対応のツールを特定する
  - 封じ込め機能を使う
  - アクセスを事前準備
  - ツールを自動デプロイ
  - インシデント対応ゲームデーを実施する

## 信頼性

設計原則は下記の通り
- 復旧手順をテスト
- 障害から自動的に復旧
- 水平方向にスケールしてシステム全体の可用性を高める
- キャパシティーを推測しない
- オートメーションで変更を管理

### ベストプラクティス
- 基盤
  - データセンターへの十分なネットワーク帯域とか。ただし一つのプロジェクトの範囲を超えている（物理マシンを使ったオンプレ環境ならともかく）
  - AWSで解決
    - 不必要なプロビジョニングには注意
      - 自動モニタリング
  - サービスの制限がいくつか
    - API のコール数
    - Direct Connectの接続毎のデータ転送量
  - IAM, AWS Trusted Advisor, AWS Shield(DDoS防止サービス)
- 変更管理
  - インフラレベル的な変更管理は容易（スケーラブルだから）
    - プロビジョニングツールを使っているなら注意必要だけども
  - モニタリングはCloudWatchで
  - CLoudTrail, Config, Auto Scaling
  - 負荷テストを行って、、スケールイン・アウトのワークロード要件を満たすか測定する
- 障害の管理
  - データのバックアップ
    - データ、アプリケーション動作環境（OS)をバックアップして、平均復旧時間MTTR、目標復旧地点（RPO)の要件を満たす
    - 自動化する(EBS、RDSのスナップショット、S3の複数バージョン)
  - コンポーネントのエラーに耐える方法
    - ワークロードを弾力性のある設計にする。障害に耐えるようにワークロードを分散する
       - すべてのレイヤーをモニタリングしてエラーを検知
       - 疎結合の依存関係
       - ハードな依存関係をソフトな依存関係に変換するために、グレイスフルデグラデーション(graceful degradation)を実装する
         - UIの言葉では「最新ブラウザで動作するように作って、古いブラウザでは基本的な機能のみ利用するようにする」
         - メンテナンスコストは高そう
       - 復旧全体を自動化
       - 複数の場所にデプロイ
       - 修復を自動化
       - 通知
  - 弾力性のテスト
    - 本番環境へのテストを定期的に行って潜伏バグを洗い出す
      - 予期しない障害に関するプレイブックを使用する
      - 根本原因の分析（RCA)を実施
      - 障害を生成して、回復力をテストする（定期的に）
      - ゲームデー
  - 災害対策(DR)
    - 目標復旧時間（RTO）とRPOの目標に一致するようにリソース、場所、復元するデータの機能を定義する
  - CLoudFormation, S3(Glacier), KMS

## パフォーマンス効率

設計原則は下記の通り

- 最新テクノロジーの標準化
  - 実行方法を学習するのではなく利用できる形にすること
- 数分でのグローバル展開
- サーバレスアーキテクチャの使用
- 頻繁に実験可能
- システムを深く理解

### ベストプラクティス

データ駆動型のアプローチを選択する

- 選択
  - データ駆動型のアプローチで最適なソリューションを見つけること
    - AWSサービスやリソースの理解
    - 予算も考慮する
    - 既存のリファレンスアーキテクチャを使ってみる
    - ガイダンス
    - 既存のワークロードのベンチマーク
    - ワークロードの負荷試験を実施
      - ボトルネックや過剰なキャパシティを判別する
  - コンピューティング
  - ストレージ
    - アクセス方法 (ブロック、ファイル、オブジェクト)
    - アクセスパターン（ランダム、シーケンシャル）
    - スループット
    - アクセス頻度（オンライン、オフライン、アーカイブ）
    - 更新頻度（WORM、動的）
    - 可用性、耐久性
  - データベース
    - 可用性
    - 整合性
    - パーティション対応性
    - レイテンシー
    - 耐久性
    - スケーラビリティ
    - クエリ機能
  - ネットワーク
    - レイテンシー
    - スループット
    - Route 53によるレイテンシーベースのルーティング
    - VPCエンドポイントや Direct Connectによるネットワーク距離の削減、ジッター削減
- レビュー
  - アーキテクチャのどの部分でパフォーマンスが成約されているかを把握することでそうした制約を緩和できるリリースを見つけられる
- モニタリング
  - Kinesis, SQS, Lambdaを通じてアクションをトリガーできる
  - システムパフォーマンスをモニタリングして、低下の兆候を見つけ、OSやアプリ内部的及び外部的な要素を修正
    - KPI
    - アラート通知
    - メトリクスを定期的に見直す
- トレードオフ
  - 何を重視するのかを決定すること
    - 多くは整合性、耐久性、時間とレイテンシーを引き換えにパフォーマンスを向上させることが可能
      - パフォーマンスが最も重要な分野を理解
      - デザインパターンとサービスについて理解
      - 影響を明らかに
      - 影響を測定


## コスト最適化

- 消費モデルの導入
- 全体的な効率を測定
- データセンター運用のための費用排除
- 費用を分析して帰結
- アプリケーションレベルのマネージドサービスを使用して所有コスト削減

### ベストプラクティス

- 費用認識
  - オンプレとは違うよ
  - Cost ExplorerやBudgets
  - アカウント構造を実装する
  - グループとロールを実装する
  - プロジェクトのライフサイクル
  - すべてのリソースにタグをつける
  - 通知する。会議とかするといいかもね。
  - データ転送コスト
    - 削減するサービスを実装.CloudFrontなどと言ったCDNやElastiCache、DirectConnectによるキャッシュ
- 費用対効果の高いリソース
  - ニーズに最も適した方法で、EC2インスタンスやその他のサービスを利用する
    - リザーブドインスタンス
    - スポットインスタンス
  - CLoudWatch と Trusted Advisor を使う
  - Auroraを使うと、DBのライセンスコストを排除
  - Direct Connet と CloudFrontでデータ転送の最適化
- 需要と供給を一致させる
  - Auto Scaling
  - 使用率が著しく低いインスタンスが生じるのを回避する
- 長期的な最適化
  - AWS Trusted Advisor
## レビュープロセス
アーキテクチャの評価は非難ではなく、掘り下げる一貫した方法でじっしされること  
また、数時間で終わる軽いプロセスである必要がある。

- ホワイトボードのある会議室
- 印刷した設計図や設計ノート

- 次の反論に対処
  - 忙しい（大きな仕事を始める準備をしているときによくある
    - 大きな仕事が円滑に進むかもよ
    - 製品のライフサイクルをレビューして、リスク低減計画を建てられるよ
  - 結果が出ても対策を取る時間がない(動かせないイベントが目標の場合)
    - そのイベントを動かすことはできない
    - すべての課題に対策を講じることができないにしても、問題が生じたときの対処法を準備できる
  - 私達のソリューション実装の秘密を知られたくない
    - W-Aの質問で、秘密を開示する質問がないことを理解できる

## Reference
- [AWS Well-Architected フレームワーク](https://d1.awsstatic.com/whitepapers/ja_JP/architecture/AWS_Well-Architected_Framework.pdf?sc_icampaign=aware_well_architected_jp_wa_framework&sc_ichannel=ha&sc_icontent=awssm-3366&sc_iplace=cta&trk=awssm-3366_aware_well_architected_jp_wa_framework&refid=awsmanga_vol13-1%25262_TWITTER)