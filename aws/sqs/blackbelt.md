# Simple Queue Service (SQS)

## 柔軟性

柔軟性（アジリティ）とは疎結合であること

- つなぐコンポーネント

  - アプリケーションを疎結合にする
  - 機密性
    - アプリケーションの保護
  - 可用性
    - 耐障害性、自動回復、スケーラビリティ
  - 低価格

## つなぎ方

- つなぐ際に検討すること
  - ストリーミング / メッセージング
    - ストリーミング ... Kinesis, Managed Streaming for Kafka, API Gateway(WebSocket)
      - IOT のセンサデータ, 音声や動画をストリーミング配信する方式
      - 連続的にデータを送り、データの順序性に意味がある
    - メッセージング
      - 連続性の意味は持たないで単体で処理をする方式
  - 同期/非同期方式の検討
    - 同期方式
      - リクエスタがプロバイダの処理完了まで応答を待つ方式
    - 非同期方式
      - リクエスタが処理完了の応答を待たずに後続の処理を実施する方式
  - Push / Pull 方式検討
    - Push
      - プロデューサが任意でコンシューマに送る
    - Pull
      - コンシューマがほしいときにプロデューサから受信する
    - 両方が任意のタイミングで送受信したいときはコネクタを間に挟む
      - 双方の障害などの影響を緩和したいときに使える
  - P2P / Publish Subscribe
    - P2P
      - 1 : 1 で連携する
    - Publish Subscribe
      - 1 つのメッセージを複数のコンシューマ(Subscriber)が受信する方式
      - Publisher はトピックと呼ばれる場所に送信する

### AWS のマネージドサービスでは

| サービス名 | 同期方式 | Push/Pull | P2P/PubSub |
| ---------- | -------- | --------- | ---------- |
| SNS        | 非同期   | Push      | PubSub     |
| SQS        | 非同期   | Pull      | P2P        |
| MQ         | 非同期   | Pull      | P2P/PubSub |

## 特徴

- セキュリティ ... 暗号化
- 耐久性 .... 複数の DC に全メッセージを重複して保存
- フルマネージド
- スケーラビリティ ... 無限の TPS(Transaction per second)
- 初期投資不要 ... 毎月無料枠

## 構成要素

- プロデューサがメッセージをキューに送信(256KB まで）
- コンシューマ自身がキューからメッセージを受信

##　ユースケース

- バッファリングとバッチ化
  - 大量のバッチ処理をキューに格納
- ワークキュー
  - アプリケーション間の依存関係を弱めたい
- リクエストのオフロード
  - 重い処理が含まれていても、素早く応答したい
    - 軽い処理をプロデューサに
      - 処理だけ受け付けてキューに投げる
    - 重い処理をコンシューマに
- ターゲットのファンアウト
  - 複数の処理を並列処理をしたい
    - SNS を間に噛ませて、並列処理を簡単に実現

## キューの特徴

- スタンダドキュー

  - スループットが無制限
  - 少なくとも 1 回の配信
    - 複数回配信する可能性があるので、冪等性を確保する
  - データ順序はベストエフォート(順所が変わる)
  - 100 万件越えた場合\$0.4

- FIFO キュー
  - 1 秒に 300 件
  - 配信は 1 回
  - 順序は保つ
  - 100 万県越えた場合\$0.5

## キューのメッセージ取得方式

- ショートポーリング方式

  - 即応答。ない場合は「空」を応答
  - 複数のキューを 1 つのスレッドでポーリングするようなケース

- ロングポーリング方式
  - 最大 20 秒待つ
  - 基本はこっちがオススメ

### メッセージを取得する際のお作法

- ポーリング ... 特定の ID や条件によるメッセージの取得不可
- 取得&処理 ... 受信したメッセージを利用して各々処理実装
- 削除 ... 取り出したら削除する。削除しないと最大 14 日間滞留するため同じメッセージを取得できてしまう

## 可視性タイムアウト (Visibility timeout)

コンシューマが取得したメッセージに対して、指定された期間(デフォルト 30 秒)他のコンシューマから同一のメッセージのアクセスをブロックする機能

- 複数のコンシューマが同じメッセージを処理するのを防ぐ
- 受け取ったコンシューマが障害発生した場合、指定した期間のために再試行時間が長くなるので注意

## 遅延キューとメッセージタイマー

- メッセージにキューを送信してから一定時間経過後に利用可能になる
  - 可視性タイムアウトの前に発生する
  - 遅延キューは全体
  - メッセージタイマーは特定のメッセージに対して
    - 両方の場合はメッセージタイマーが優先
    - FIFO は未サポート

## Dead Letter Queue

正しく処理できないメッセージがキュー内に滞留し続けるのを回避するために、分離先に利用するキュー

## 暗号化

- KMS で管理されているキーを使用して SQS キュー内のメッセージの内容を保護する
  - プロデューサは KMS の暗号化
  - コンシューマは KMS の復号化
  - メッセージ本文のみ

## アクセス制御

- IAM ポリシー
- SQS ポリシー

[Actions, Resources, and Condition Keys for Amazon SQS - AWS Identity and Access Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/list_amazonsqs.html)

## メッセージ属性

最大 10 個までメタデータを保持できる。メッセージサイズ上限のサイズにも含まれ、暗号化の対象外

## モニタリング

CloudWatch に

## キューの保持期間

デフォルト 4 日、最大 14 日

## 料金

- 100 万リクエストまで無料

  - 超えた場合は、100 万件ごとに
    - スタンダードキュー ... 0.4USD
    - FIFO キュー ... 0.5USD

- [料金 - Amazon SQS | AWS](https://aws.amazon.com/jp/sqs/pricing/)

## Reference

- [20190717 AWS Black Belt Online Seminar Amazon Simple Queue Service - YouTube](https://www.youtube.com/watch?v=avfc0gQ7X0A&feature=youtu.be)
- [20190717 AWS Black Belt Online Seminar Amazon Simple Queue Service](https://www.slideshare.net/AmazonWebServicesJapan/20190717-aws-black-belt-online-seminar-amazon-simple-queue-service)
